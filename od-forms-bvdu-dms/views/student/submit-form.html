<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit OD Form - BVDU CampusFlow</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../css/variables.css">
  <link rel="stylesheet" href="../../css/theme-dark.css">
  <link rel="stylesheet" href="../../css/components-dark.css">
  
  <!-- Particles Animation -->
  <script src="../../js/particles.js" defer></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0A0E27;
      color: #E2E8F0;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(66, 133, 244, 0.08), transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(52, 168, 83, 0.08), transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 0;
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 1;
    }

    /* Navbar */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .navbar-brand {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4285F4, #34A853);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.7);
      transition: all 0.3s ease;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      font-weight: 500;
    }

    .nav-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-link.active {
      color: #fff;
      background: linear-gradient(135deg, #4285F4, #34A853);
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
    }

    /* Progress Indicator */
    .progress-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3rem;
      position: relative;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .progress-container::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      width: 100%;
      height: 3px;
      background: rgba(255, 255, 255, 0.1);
      z-index: 0;
    }

    .progress-bar {
      position: absolute;
      top: 20px;
      left: 0;
      height: 3px;
      background: linear-gradient(135deg, #4285F4, #34A853);
      z-index: 1;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(66, 133, 244, 0.5);
    }

    .step {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 25%;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .step:hover .step-circle {
      transform: scale(1.15);
      border-color: rgba(66, 133, 244, 0.6);
    }

    .step:hover .step-label {
      color: rgba(66, 133, 244, 0.9);
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(26, 31, 58, 0.8);
      border: 3px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
    }

    .step.active .step-circle {
      background: linear-gradient(135deg, #4285F4, #34A853);
      border-color: #4285F4;
      color: #fff;
      box-shadow: 0 0 20px rgba(66, 133, 244, 0.6);
      transform: scale(1.1);
    }

    .step.completed .step-circle {
      background: linear-gradient(135deg, #10B981, #059669);
      border-color: #10B981;
      color: #fff;
    }

    .step-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      transition: color 0.3s ease;
    }

    .step.active .step-label {
      color: #fff;
    }

    .step.completed .step-label {
      color: rgba(255, 255, 255, 0.7);
    }

    /* Form Card */
    .form-card {
      background: rgba(26, 31, 58, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
      max-width: 900px;
      margin: 0 auto;
    }

    .form-section {
      display: none;
      animation: fadeInUp 0.5s ease;
    }

    .form-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .section-description {
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 2rem;
    }

    /* Form Groups */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-label.required::after {
      content: ' *';
      color: #EF4444;
    }

    .form-control {
      width: 100%;
      padding: 0.875rem 1rem;
      font-size: 1rem;
      color: #fff;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .form-control:hover {
      border-color: rgba(66, 133, 244, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }

    .form-control:focus {
      outline: none;
      border-color: #4285F4;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.15);
      background: rgba(255, 255, 255, 0.05);
    }

    .form-control.error {
      border-color: #EF4444;
    }

    .error-message {
      color: #EF4444;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    select.form-control {
      cursor: pointer;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='white' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 16px;
      padding-right: 2.5rem;
      appearance: none;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 100px;
    }

    /* Checkbox */
    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .checkbox-wrapper:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(66, 133, 244, 0.3);
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #4285F4;
    }

    .checkbox-wrapper label {
      flex: 1;
      cursor: pointer;
      font-size: 0.875rem;
      margin: 0;
    }

    /* File Upload */
    .file-upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(0, 0, 0, 0.2);
    }

    .file-upload-area:hover {
      border-color: #4285F4;
      background: rgba(66, 133, 244, 0.05);
    }

    .file-upload-area.dragover {
      border-color: #4285F4;
      background: rgba(66, 133, 244, 0.1);
      transform: scale(1.02);
    }

    .file-upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .file-list {
      margin-top: 1rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .file-icon {
      font-size: 1.5rem;
    }

    .file-details {
      flex: 1;
    }

    .file-name {
      font-weight: 600;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .file-size {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .remove-file {
      background: rgba(239, 68, 68, 0.2);
      border: none;
      color: #EF4444;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .remove-file:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    /* Lectures List */
    .lecture-item {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .lecture-number {
      position: absolute;
      top: -12px;
      left: 1rem;
      background: linear-gradient(135deg, #4285F4, #34A853);
      color: #fff;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .remove-lecture {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: rgba(239, 68, 68, 0.2);
      border: none;
      color: #EF4444;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 1.25rem;
      line-height: 1;
    }

    .remove-lecture:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.1);
    }

    .add-lecture-btn {
      width: 100%;
      padding: 0.875rem;
      background: rgba(66, 133, 244, 0.1);
      border: 2px dashed rgba(66, 133, 244, 0.3);
      color: #4285F4;
      border-radius: 0.75rem;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .add-lecture-btn:hover {
      background: rgba(66, 133, 244, 0.2);
      border-color: #4285F4;
      transform: translateY(-2px);
    }

    /* Summary Panel */
    .summary-card {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .summary-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }

    .summary-value {
      font-weight: 600;
    }

    /* Buttons */
    .btn {
      padding: 0.875rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4285F4, #34A853);
      color: #fff;
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(66, 133, 244, 0.6);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      justify-content: space-between;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Info Alert */
    .info-alert {
      background: rgba(66, 133, 244, 0.1);
      border: 1px solid rgba(66, 133, 244, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 0.75rem;
    }

    .info-alert-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .info-alert-content {
      flex: 1;
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Grid Layout */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }

    .form-grid-full {
      grid-column: 1 / -1;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-card {
        padding: 1.5rem;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .step-label {
        font-size: 0.75rem;
      }

      .step-circle {
        width: 36px;
        height: 36px;
      }

      .btn-group {
        flex-direction: column;
      }

      .progress-container {
        margin-bottom: 2rem;
      }
    }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="../../index.html" class="navbar-brand flex items-center gap-3">
          <span class="text-3xl">üéì</span>
          <span>BVDU CampusFlow</span>
        </a>
        <ul class="flex items-center gap-2">
          <li><a href="dashboard.html" class="nav-link flex items-center gap-2">
            <span>üìä</span> Dashboard
          </a></li>
          <li><a href="submit-form.html" class="nav-link active flex items-center gap-2">
            <span>üìù</span> Submit Form
          </a></li>
          <li><a href="my-forms.html" class="nav-link flex items-center gap-2">
            <span>üìã</span> My Forms
          </a></li>
          <li><a href="profile.html" class="nav-link flex items-center gap-2">
            <span>üë§</span> Profile
          </a></li>
          <li><a href="#" class="nav-link flex items-center gap-2" id="logoutBtn">
            <span>üö™</span> Logout
          </a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container mx-auto px-6 py-8 pb-20">
    <!-- Page Header -->
    <div class="mb-8 text-center">
      <h1 class="text-4xl font-bold mb-3" style="font-family: 'Space Grotesk', sans-serif;">
        Submit OD Form üìù
      </h1>
      <p class="text-lg" style="color: rgba(255, 255, 255, 0.6);">
        Fill in the details to request On-Duty approval for missed lectures
      </p>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
      <div class="step active" data-step="1" onclick="goToStep(1)" style="cursor: pointer;">
        <div class="step-circle">1</div>
        <div class="step-label">Personal Info</div>
      </div>
      <div class="step" data-step="2" onclick="goToStep(2)" style="cursor: pointer;">
        <div class="step-circle">2</div>
        <div class="step-label">Event Details</div>
      </div>
      <div class="step" data-step="3" onclick="goToStep(3)" style="cursor: pointer;">
        <div class="step-circle">3</div>
        <div class="step-label">Missed Lectures</div>
      </div>
      <div class="step" data-step="4" onclick="goToStep(4)" style="cursor: pointer;">
        <div class="step-circle">4</div>
        <div class="step-label">Review & Submit</div>
      </div>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <form id="odForm">
        <!-- Step 1: Personal Information -->
        <div class="form-section active" data-section="1">
          <h2 class="section-title">üìã Personal Information</h2>
          <p class="section-description">Your details will be auto-filled from your profile</p>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label required">Full Name</label>
              <input type="text" class="form-control" id="studentName" placeholder="Enter your full name" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Roll Number</label>
              <input type="text" class="form-control" id="rollNumber" placeholder="e.g., CS2021001" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Course</label>
              <input type="text" class="form-control" id="course" placeholder="e.g., B.Tech Computer Science" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Semester</label>
              <input type="text" class="form-control" id="semester" placeholder="e.g., VI" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Division</label>
              <input type="text" class="form-control" id="division" placeholder="e.g., A" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Contact Number</label>
              <input type="tel" class="form-control" id="contactNumber" placeholder="+91 98765 43210" required>
            </div>
          </div>

          <div class="info-alert">
            <div class="info-alert-icon">‚ÑπÔ∏è</div>
            <div class="info-alert-content">
              <strong>Note:</strong> For prototype testing, personal information fields are editable. In production, these will be auto-filled from your profile.
            </div>
          </div>

          <div class="btn-group">
            <div></div>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Next Step ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 2: Event Details -->
        <div class="form-section" data-section="2">
          <h2 class="section-title">üéØ Event Details</h2>
          <p class="section-description">Select from verified events created by event leaders</p>

          <div class="form-grid">
            <div class="form-group form-grid-full">
              <label class="form-label required">Select Event</label>
              <select class="form-control" id="eventSelect" required onchange="handleEventSelection()">
                <option value="">Choose an event...</option>
                <!-- Will be populated dynamically -->
              </select>
              <span class="error-message">Please select an event</span>
              <small style="color: #64748B; display: block; margin-top: 0.5rem;">
                ‚ÑπÔ∏è All event details will be auto-filled once you select an event
              </small>
            </div>

            <!-- Hidden Event ID -->
            <input type="hidden" id="eventId">

            <div class="form-group form-grid-full">
              <label class="form-label">Event Name</label>
              <input type="text" class="form-control" id="eventName" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group">
              <label class="form-label">Event Type</label>
              <input type="text" class="form-control" id="eventType" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group">
              <label class="form-label">Event Category</label>
              <input type="text" class="form-control" id="eventCategory" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group">
              <label class="form-label">Event Date</label>
              <input type="date" class="form-control" id="eventDate" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group">
              <label class="form-label">Start Time</label>
              <input type="time" class="form-control" id="startTime" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group">
              <label class="form-label">End Time</label>
              <input type="time" class="form-control" id="endTime" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label">Event Venue</label>
              <input type="text" class="form-control" id="eventVenue" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label">Organizing Club</label>
              <input type="text" class="form-control" id="eventOrganizer" readonly style="background: rgba(0,0,0,0.2);">
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label">Event Description</label>
              <textarea class="form-control" id="eventDescription" readonly style="background: rgba(0,0,0,0.2); min-height: 80px;"></textarea>
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label">Event Leader</label>
              <input type="text" class="form-control" id="eventLeader" readonly style="background: rgba(0,0,0,0.2);">
              <input type="hidden" id="eventLeaderId">
            </div>

            <div class="form-group">
              <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                <span id="nationalBadge" style="display: none;">üåè National/International</span>
                <span id="universityBadge" style="display: none;">üéì University Event</span>
                <span id="certificateBadge" style="display: none;">üìú Certificate Provided</span>
                <span id="odEligibleBadge" style="display: none;">‚úÖ OD Eligible</span>
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">
              ‚Üê Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Next Step ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 3: Missed Lectures -->
        <div class="form-section" data-section="3">
          <h2 class="section-title">üìö Missed Lectures</h2>
          <p class="section-description">Add all lectures you missed during the event</p>

          <div id="lecturesContainer">
            <!-- Lectures will be added here dynamically -->
          </div>

          <button type="button" class="add-lecture-btn" onclick="addLecture()">
            <span>‚ûï</span> Add Lecture
          </button>

          <div class="summary-card" style="margin-top: 1.5rem;">
            <div class="summary-title">üìä Summary</div>
            <div class="summary-row">
              <span class="summary-label">Total Lectures Missed</span>
              <span class="summary-value" id="totalLectures">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Total Hours</span>
              <span class="summary-value" id="totalHours">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Subjects Affected</span>
              <span class="summary-value" id="totalSubjects">0</span>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">
              ‚Üê Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Next Step ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="form-section" data-section="4">
          <h2 class="section-title">‚úÖ Review & Submit</h2>
          <p class="section-description">Review your form before submission</p>

          <!-- Personal Info Summary -->
          <div class="summary-card">
            <div class="summary-title">
              üìã Personal Information
              <button type="button" class="btn btn-secondary" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="goToStep(1)">
                Edit
              </button>
            </div>
            <div class="summary-row">
              <span class="summary-label">Name</span>
              <span class="summary-value" id="reviewName">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Roll Number</span>
              <span class="summary-value" id="reviewRoll">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Course & Semester</span>
              <span class="summary-value" id="reviewCourse">-</span>
            </div>
          </div>

          <!-- Event Details Summary -->
          <div class="summary-card">
            <div class="summary-title">
              üéØ Event Details
              <button type="button" class="btn btn-secondary" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="goToStep(2)">
                Edit
              </button>
            </div>
            <div class="summary-row">
              <span class="summary-label">Event Name</span>
              <span class="summary-value" id="reviewEventName">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Event Type</span>
              <span class="summary-value" id="reviewEventType">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Date & Time</span>
              <span class="summary-value" id="reviewDateTime">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Venue</span>
              <span class="summary-value" id="reviewVenue">-</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Organizer</span>
              <span class="summary-value" id="reviewOrganizer">-</span>
            </div>
          </div>

          <!-- Missed Lectures Summary -->
          <div class="summary-card">
            <div class="summary-title">
              üìö Missed Lectures
              <button type="button" class="btn btn-secondary" style="margin-left: auto; padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="goToStep(3)">
                Edit
              </button>
            </div>
            <div class="summary-row">
              <span class="summary-label">Total Lectures</span>
              <span class="summary-value" id="reviewTotalLectures">0</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Total Hours</span>
              <span class="summary-value" id="reviewTotalHours">0</span>
            </div>
            <div id="reviewLecturesList"></div>
          </div>

          <!-- File Attachments -->
          <div class="summary-card">
            <div class="summary-title">üìé Attachments</div>
            <div class="file-upload-area" id="fileUploadArea">
              <div class="file-upload-icon">üìÅ</div>
              <h3 style="margin-bottom: 0.5rem;">Drop files here or click to browse</h3>
              <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.875rem;">
                Supported: PDF, JPG, PNG (Max 5MB per file)
              </p>
              <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
            </div>
            <div class="file-list" id="fileList"></div>
          </div>

          <!-- Confirmation -->
          <div class="checkbox-wrapper" style="margin-top: 1.5rem;">
            <input type="checkbox" id="confirmAccuracy" required>
            <label for="confirmAccuracy">I confirm that all information provided is accurate and complete</label>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">
              ‚Üê Previous
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Submit Form üöÄ
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="../../js/config.js"></script>
  <script>
    // Initialize Supabase (ready for when API keys are added)
    let supabaseClient = null;
    try {
      if (typeof supabase !== 'undefined') {
        const { createClient } = supabase;
        supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
      }
    } catch (error) {
      console.log('Supabase not initialized - using mock mode');
    }
    
    let currentStep = 1;
    let currentUser = null;
    let lectures = [];
    let uploadedFiles = [];
    let lectureCounter = 0;

    // Check Authentication
    async function checkAuth() {
      try {
        // Check sessionStorage first
        const sessionUser = sessionStorage.getItem('currentUser');
        if (sessionUser) {
          const userData = JSON.parse(sessionUser);
          if (userData && userData.role === 'student') {
            currentUser = userData;
            loadUserData(userData);
            return userData;
          }
        }

        if (!supabaseClient) {
          window.location.href = '../../login.html?from=submit-form';
          return null;
        }

        const { data: { user }, error } = await supabaseClient.auth.getUser();
        
        if (!user || error) {
          window.location.href = '../../login.html?from=submit-form';
          return null;
        }
        
        const { data: profile, error: profileError } = await supabaseClient
          .from('users')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (profileError) {
          console.error('Profile error:', profileError);
          window.location.href = '../../login.html?from=submit-form';
          return null;
        }
        
        currentUser = profile;
        sessionStorage.setItem('currentUser', JSON.stringify(profile));
        loadUserData(profile);
        return profile;
      } catch (error) {
        console.error('Auth error:', error);
        window.location.href = '../../login.html?from=submit-form';
        return null;
      }
    }

    // Load User Data into Form (Autofill personal information)
    function loadUserData(userData) {
      const fullName = userData.full_name || `${userData.first_name || ''} ${userData.middle_name || ''} ${userData.surname || ''}`.trim();
      
      document.getElementById('studentName').value = fullName;
      document.getElementById('rollNumber').value = userData.roll_number || userData.prn || '';
      document.getElementById('course').value = userData.course || '';
      document.getElementById('semester').value = userData.year ? `Year ${userData.year}` : '';
      document.getElementById('division').value = userData.division || '';
      document.getElementById('contactNumber').value = userData.phone || '';
      
      // Make personal fields readonly since they're autofilled
      document.getElementById('studentName').setAttribute('readonly', true);
      document.getElementById('rollNumber').setAttribute('readonly', true);
      document.getElementById('course').setAttribute('readonly', true);
      document.getElementById('semester').setAttribute('readonly', true);
      document.getElementById('division').setAttribute('readonly', true);
    }

    // Events loaded from database only

    // LocalStorage Helper Functions
    const STORAGE_KEY = 'bvdu_events';

    function getEventsFromStorage() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      } catch (error) {
        console.error('Error loading from localStorage:', error);
      }
      return [];
    }

    // Load Events into Dropdown
    async function loadEvents() {
      try {
        if (!supabaseClient) {
          console.error('Supabase not initialized');
          return;
        }

        // Load approved events from Supabase
        const { data: storedEvents, error } = await supabaseClient
          .from('events')
          .select('*')
          .eq('od_eligible', true)
          .eq('status', 'approved')
          .order('event_date', { ascending: false });

        if (error) {
          console.error('Error loading events:', error);
          const eventSelect = document.getElementById('eventSelect');
          eventSelect.innerHTML = '<option value="">Error loading events</option>';
          return;
        }
        
        // Get current date and 3-day deadline logic
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Filter events:
        // 1. Faculty approved only
        // 2. OD eligible
        // 3. Within 3-day deadline after event date
        const eligibleEvents = storedEvents.filter(event => {
          // Must be faculty approved
          if (event.faculty_status !== 'approved') return false;
          
          // Must be OD eligible
          if (!event.od_eligible) return false;
          
          // Calculate deadline: event_date + 3 days
          const eventDate = new Date(event.event_date);
          eventDate.setHours(0, 0, 0, 0);
          
          const deadline = new Date(eventDate);
          deadline.setDate(deadline.getDate() + 3);
          
          // Event is eligible if today <= deadline
          return today <= deadline;
        });

        // Sort by event date (most recent first)
        eligibleEvents.sort((a, b) => new Date(b.event_date) - new Date(a.event_date));

        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = '<option value="">Choose an event...</option>';
        
        if (eligibleEvents.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No events available for OD form submission';
          option.disabled = true;
          eventSelect.appendChild(option);
          return;
        }

        eligibleEvents.forEach(event => {
          // Calculate days remaining
          const eventDate = new Date(event.event_date);
          eventDate.setHours(0, 0, 0, 0);
          const deadline = new Date(eventDate);
          deadline.setDate(deadline.getDate() + 3);
          const daysRemaining = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          
          const option = document.createElement('option');
          option.value = event.event_id;
          option.textContent = `${event.event_name} - ${formatEventDate(event.event_date)} (${daysRemaining} day${daysRemaining !== 1 ? 's' : ''} left)`;
          option.dataset.event = JSON.stringify(event);
          eventSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading events:', error);
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = '<option value="">Choose an event...</option>';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading events';
        option.disabled = true;
        eventSelect.appendChild(option);
      }
    }

    // Format Event Date
    function formatEventDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
      });
    }

    // Handle Event Selection
    function handleEventSelection() {
      const eventSelect = document.getElementById('eventSelect');
      const selectedOption = eventSelect.options[eventSelect.selectedIndex];
      
      if (selectedOption.value === '') {
        // Clear all fields
        document.getElementById('eventId').value = '';
        document.getElementById('eventName').value = '';
        document.getElementById('eventType').value = '';
        document.getElementById('eventCategory').value = '';
        document.getElementById('eventDate').value = '';
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('eventVenue').value = '';
        document.getElementById('eventOrganizer').value = '';
        document.getElementById('eventDescription').value = '';
        document.getElementById('eventLeader').value = '';
        document.getElementById('eventLeaderId').value = '';
        
        // Hide badges
        document.getElementById('nationalBadge').style.display = 'none';
        document.getElementById('universityBadge').style.display = 'none';
        document.getElementById('certificateBadge').style.display = 'none';
        document.getElementById('odEligibleBadge').style.display = 'none';
        return;
      }
      
      const event = JSON.parse(selectedOption.dataset.event);
      
      // Auto-fill all event details
      document.getElementById('eventId').value = event.event_id;
      document.getElementById('eventName').value = event.event_name;
      document.getElementById('eventType').value = event.event_type;
      document.getElementById('eventCategory').value = event.event_category || '';
      document.getElementById('eventDate').value = event.event_date;
      document.getElementById('startTime').value = event.start_time;
      document.getElementById('endTime').value = event.end_time;
      document.getElementById('eventVenue').value = event.venue;
      document.getElementById('eventOrganizer').value = event.organizing_club;
      document.getElementById('eventDescription').value = event.event_description || '';
      document.getElementById('eventLeader').value = event.event_leader_name;
      document.getElementById('eventLeaderId').value = event.event_leader_id;
      
      // Show badges
      document.getElementById('nationalBadge').style.display = event.is_national ? 'inline-block' : 'none';
      document.getElementById('universityBadge').style.display = event.is_university ? 'inline-block' : 'none';
      document.getElementById('certificateBadge').style.display = event.certificate_provided ? 'inline-block' : 'none';
      document.getElementById('odEligibleBadge').style.display = event.od_eligible ? 'inline-block' : 'none';
    }

    // Navigation Functions
    function nextStep() {
      if (validateStep(currentStep, false)) {
        if (currentStep < 4) {
          currentStep++;
          updateStepDisplay();
          if (currentStep === 4) {
            populateReview();
          }
        }
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }

    function goToStep(step) {
      currentStep = step;
      updateStepDisplay();
      
      // Populate review when navigating to step 4
      if (step === 4) {
        populateReview();
      }
    }

    function updateStepDisplay() {
      // Update sections
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      document.querySelector(`[data-section="${currentStep}"]`).classList.add('active');

      // Update progress steps based on validation
      document.querySelectorAll('.step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');
        
        if (stepNum === currentStep) {
          step.classList.add('active');
          step.querySelector('.step-circle').textContent = stepNum;
        } else if (validateStep(stepNum)) {
          // Only mark as completed if all fields are valid
          step.classList.add('completed');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else {
          step.querySelector('.step-circle').textContent = stepNum;
        }
      });

      // Calculate progress based on completed steps
      let completedSteps = 0;
      for (let i = 1; i <= 4; i++) {
        if (validateStep(i)) completedSteps++;
      }
      const progress = (completedSteps / 4) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Validation (silent = true for step indicator, false for navigation)
    function validateStep(step, silent = true) {
      switch(step) {
        case 1:
          return validatePersonalInfo(silent);
        case 2:
          return validateEventDetails(silent);
        case 3:
          return validateLectures(silent);
        case 4:
          return validateReview(silent);
        default:
          return false;
      }
    }

    function validatePersonalInfo(silent = true) {
      // Personal info is autofilled and readonly, always valid
      const studentName = document.getElementById('studentName').value;
      const rollNumber = document.getElementById('rollNumber').value;
      const course = document.getElementById('course').value;
      const semester = document.getElementById('semester').value;
      const division = document.getElementById('division').value;
      
      return !!(studentName && rollNumber && course && semester && division);
    }

    function validateEventDetails(silent = true) {
      // Check if event is selected
      const eventSelect = document.getElementById('eventSelect');
      if (!eventSelect.value) {
        if (!silent) {
          eventSelect.classList.add('error');
          alert('Please select an event from the dropdown');
        }
        return false;
      }

      // Verify event details are populated
      const eventId = document.getElementById('eventId').value;
      if (!eventId) {
        if (!silent) {
          alert('Event details not loaded. Please select an event again.');
        }
        return false;
      }

      return true;
    }

    function validateLectures(silent = true) {
      const lectureItems = document.querySelectorAll('.lecture-item');
      
      if (lectureItems.length === 0) {
        if (!silent) {
          alert('Please add at least one missed lecture');
        }
        return false;
      }

      // Validate each lecture has required fields filled
      let isValid = true;
      lectureItems.forEach(item => {
        const requiredFields = ['subjectName', 'facultyName', 'lectureDate', 'lectureTime', 'duration', 'lectureType'];
        
        requiredFields.forEach(field => {
          const input = item.querySelector(`[data-field="${field}"]`);
          if (!input || !input.value.trim()) {
            if (!silent) {
              if (input) input.style.border = '1px solid #EA4335';
            }
            isValid = false;
          } else {
            if (input) input.style.border = '';
          }
        });
      });

      if (!isValid && !silent) {
        alert('Please fill in all required fields in the lecture details');
      }

      return isValid;
    }

    function validateReview(silent = true) {
      // Check if lectures exist and all previous steps are valid
      if (!validateEventDetails(true) || !validateLectures(true)) {
        return false;
      }

      const confirmCheckbox = document.getElementById('confirmAccuracy');
      if (!confirmCheckbox || !confirmCheckbox.checked) {
        if (!silent) {
          alert('Please confirm that all information is accurate');
        }
        return false;
      }
      return true;
    }

    // Lecture Management
    function addLecture() {
      lectureCounter++;
      const lectureId = `lecture-${lectureCounter}`;
      
      const lectureHTML = `
        <div class="lecture-item" id="${lectureId}">
          <div class="lecture-number">Lecture ${lectureCounter}</div>
          <button type="button" class="remove-lecture" onclick="removeLecture('${lectureId}')">√ó</button>
          
          <div class="form-grid" style="margin-top: 0.5rem;">
            <div class="form-group">
              <label class="form-label required">Subject Name</label>
              <input type="text" class="form-control" data-field="subjectName" required>
            </div>

            <div class="form-group">
              <label class="form-label">Subject Code</label>
              <input type="text" class="form-control" data-field="subjectCode">
            </div>

            <div class="form-group">
              <label class="form-label required">Faculty Name</label>
              <input type="text" class="form-control" data-field="facultyName" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Lecture Date</label>
              <input type="date" class="form-control" data-field="lectureDate" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Lecture Time</label>
              <input type="time" class="form-control" data-field="lectureTime" required>
            </div>

            <div class="form-group">
              <label class="form-label required">Duration (minutes)</label>
              <input type="number" class="form-control" data-field="duration" value="60" min="30" max="180" required>
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label required">Lecture Type</label>
              <select class="form-control" data-field="lectureType" required>
                <option value="">Select Type</option>
                <option value="Theory">Theory</option>
                <option value="Practical">Practical</option>
                <option value="Tutorial">Tutorial</option>
              </select>
            </div>
          </div>
        </div>
      `;

      document.getElementById('lecturesContainer').insertAdjacentHTML('beforeend', lectureHTML);
      
      // Add real-time validation to lecture inputs
      const lectureItem = document.getElementById(lectureId);
      const inputs = lectureItem.querySelectorAll('input, select');
      inputs.forEach(input => {
        input.addEventListener('input', () => updateStepDisplay());
        input.addEventListener('change', () => updateStepDisplay());
      });
      
      updateLectureSummary();
      updateStepDisplay();
    }

    function removeLecture(lectureId) {
      document.getElementById(lectureId).remove();
      updateLectureSummary();
      updateStepDisplay();
    }

    function updateLectureSummary() {
      const lectureItems = document.querySelectorAll('.lecture-item');
      const totalLectures = lectureItems.length;
      let totalMinutes = 0;
      const subjects = new Set();

      lectureItems.forEach(item => {
        const duration = item.querySelector('[data-field="duration"]').value;
        const subject = item.querySelector('[data-field="subjectName"]').value;
        
        if (duration) totalMinutes += parseInt(duration);
        if (subject) subjects.add(subject);
      });

      const totalHours = (totalMinutes / 60).toFixed(1);

      document.getElementById('totalLectures').textContent = totalLectures;
      document.getElementById('totalHours').textContent = `${totalHours} hrs`;
      document.getElementById('totalSubjects').textContent = subjects.size;
    }

    function getLecturesData() {
      const lectureItems = document.querySelectorAll('.lecture-item');
      const lecturesData = [];

      lectureItems.forEach(item => {
        const lecture = {
          subjectName: item.querySelector('[data-field="subjectName"]').value,
          subjectCode: item.querySelector('[data-field="subjectCode"]').value,
          facultyName: item.querySelector('[data-field="facultyName"]').value,
          lectureDate: item.querySelector('[data-field="lectureDate"]').value,
          lectureTime: item.querySelector('[data-field="lectureTime"]').value,
          duration: parseInt(item.querySelector('[data-field="duration"]').value),
          lectureType: item.querySelector('[data-field="lectureType"]').value
        };
        lecturesData.push(lecture);
      });

      return lecturesData;
    }

    // File Upload
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');

    fileUploadArea.addEventListener('click', () => fileInput.click());

    fileUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', () => {
      fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        // Validate file
        if (!['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) {
          alert(`${file.name} is not a supported file type`);
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          alert(`${file.name} is larger than 5MB`);
          return;
        }

        uploadedFiles.push(file);
        addFileToList(file);
      });
    }

    function addFileToList(file) {
      const fileId = `file-${Date.now()}-${Math.random()}`;
      const fileSize = (file.size / 1024).toFixed(1);
      const fileIcon = file.type.includes('pdf') ? 'üìÑ' : 'üñºÔ∏è';

      const fileHTML = `
        <div class="file-item" id="${fileId}">
          <div class="file-info">
            <div class="file-icon">${fileIcon}</div>
            <div class="file-details">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${fileSize} KB</div>
            </div>
          </div>
          <button type="button" class="remove-file" onclick="removeFile('${fileId}', '${file.name}')">√ó</button>
        </div>
      `;

      fileList.insertAdjacentHTML('beforeend', fileHTML);
    }

    function removeFile(fileId, fileName) {
      document.getElementById(fileId).remove();
      uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
    }

    // Review & Populate
    function populateReview() {
      // Personal Info
      document.getElementById('reviewName').textContent = document.getElementById('studentName').value || '-';
      document.getElementById('reviewRoll').textContent = document.getElementById('rollNumber').value || '-';
      
      const course = document.getElementById('course').value || '-';
      const semester = document.getElementById('semester').value || '-';
      document.getElementById('reviewCourse').textContent = course !== '-' && semester !== '-' ? `${course}, ${semester}` : '-';

      // Event Details
      document.getElementById('reviewEventName').textContent = document.getElementById('eventName').value;
      document.getElementById('reviewEventType').textContent = document.getElementById('eventType').value;
      
      const eventDate = new Date(document.getElementById('eventDate').value).toLocaleDateString();
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      document.getElementById('reviewDateTime').textContent = `${eventDate}, ${startTime} - ${endTime}`;
      
      document.getElementById('reviewVenue').textContent = document.getElementById('eventVenue').value;
      document.getElementById('reviewOrganizer').textContent = document.getElementById('eventOrganizer').value;

      // Lectures Summary
      const lecturesData = getLecturesData();
      const totalMinutes = lecturesData.reduce((sum, l) => sum + l.duration, 0);
      const totalHours = (totalMinutes / 60).toFixed(1);

      document.getElementById('reviewTotalLectures').textContent = lecturesData.length;
      document.getElementById('reviewTotalHours').textContent = `${totalHours} hrs`;

      // Lecture List
      const lectureListHTML = lecturesData.map((lecture, index) => `
        <div class="summary-row" style="flex-direction: column; align-items: flex-start; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-top: 0.5rem;">
          <strong style="margin-bottom: 0.5rem;">Lecture ${index + 1}: ${lecture.subjectName}</strong>
          <div style="font-size: 0.875rem; color: rgba(255,255,255,0.6);">
            ${lecture.facultyName} ‚Ä¢ ${lecture.lectureType} ‚Ä¢ ${lecture.duration} mins
          </div>
        </div>
      `).join('');

      document.getElementById('reviewLecturesList').innerHTML = lectureListHTML;
    }

    // Form Submission
    document.getElementById('odForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!validateReview()) return;

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></span> Submitting...';

      try {
        const formData = {
          // Student Info
          student_id: currentUser.id,
          
          // Event Details
          event_name: document.getElementById('eventName').value,
          event_type: document.getElementById('eventType').value,
          event_date: document.getElementById('eventDate').value,
          event_start_time: document.getElementById('startTime').value,
          event_end_time: document.getElementById('endTime').value,
          event_venue: document.getElementById('eventVenue').value,
          event_organizer: document.getElementById('eventOrganizer').value,
          event_description: document.getElementById('eventDescription').value,
          is_national: document.getElementById('isNational').checked,
          is_university: document.getElementById('isUniversity').checked,
          event_leader_id: document.getElementById('eventLeader').value,
          
          // Lectures
          missed_lectures: getLecturesData(),
          total_lectures: getLecturesData().length,
          total_hours: (getLecturesData().reduce((sum, l) => sum + l.duration, 0) / 60).toFixed(1),
          
          // Status
          status: 'submitted',
          submission_date: new Date().toISOString()
        };

        // Here you would upload files to Supabase Storage and save form data
        // For prototype, just simulate success
        console.log('Form Data:', formData);
        console.log('Files:', uploadedFiles);

        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Show success message
        alert('‚úÖ OD Form submitted successfully!\n\nYour form has been submitted and sent to the Event Leader for review. You can track its progress from your dashboard.');
        
        // Redirect to dashboard
        window.location.href = 'dashboard.html';

      } catch (error) {
        console.error('Submission error:', error);
        alert('‚ùå Error submitting form. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Form üöÄ';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      if (supabaseClient) {
        await supabaseClient.auth.signOut();
      }
      localStorage.removeItem('user');
      window.location.href = '../../login.html';
    });

    // Real-time validation triggers
    function setupRealTimeValidation() {
      // Event selection change
      const eventSelect = document.getElementById('eventSelect');
      if (eventSelect) {
        eventSelect.addEventListener('change', () => updateStepDisplay());
      }

      // Confirmation checkbox
      const confirmCheckbox = document.getElementById('confirmAccuracy');
      if (confirmCheckbox) {
        confirmCheckbox.addEventListener('change', () => updateStepDisplay());
      }

      // Listen for lecture additions/removals
      const observer = new MutationObserver(() => {
        updateStepDisplay();
      });

      const lecturesContainer = document.getElementById('lecturesContainer');
      if (lecturesContainer) {
        observer.observe(lecturesContainer, { childList: true, subtree: true });
      }
    }

    // Initialize
    async function init() {
      await checkAuth();
      await loadEvents();
      // Add first lecture by default
      addLecture();
      setupRealTimeValidation();
      updateStepDisplay();
    }

    init();
  </script>
</body>
</html>
