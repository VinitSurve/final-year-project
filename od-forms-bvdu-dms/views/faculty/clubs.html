<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Clubs - BVDU CampusFlow</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0A0E27;
      color: #E2E8F0;
      overflow-x: hidden;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 30%, rgba(66, 133, 244, 0.08), transparent 50%),
                  radial-gradient(circle at 80% 70%, rgba(52, 168, 83, 0.08), transparent 50%);
      z-index: 0;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 0;
      pointer-events: none;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Navbar */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 14, 39, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-brand {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .nav-menu {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .nav-link {
      color: #94A3B8;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-link:hover {
      color: #4285F4;
      background: rgba(66, 133, 244, 0.1);
    }

    .nav-link.active {
      color: #4285F4;
      background: rgba(66, 133, 244, 0.15);
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .page-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: #94A3B8;
      font-size: 1.125rem;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      border-color: rgba(66, 133, 244, 0.3);
      transform: translateY(-2px);
    }

    .stat-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .stat-icon {
      font-size: 1.5rem;
    }

    .stat-label {
      color: #94A3B8;
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #E2E8F0;
    }

    /* Clubs Grid */
    .clubs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .club-card {
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .club-card:hover {
      border-color: rgba(66, 133, 244, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(66, 133, 244, 0.1);
    }

    .club-header {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .club-icon {
      font-size: 2.5rem;
    }

    .club-info {
      flex: 1;
    }

    .club-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: #E2E8F0;
      margin-bottom: 0.25rem;
    }

    .club-category {
      font-size: 0.875rem;
      color: #94A3B8;
      padding: 0.25rem 0.75rem;
      background: rgba(66, 133, 244, 0.1);
      border-radius: 1rem;
      display: inline-block;
    }

    .club-description {
      color: #94A3B8;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 1rem;
    }

    .club-details {
      display: flex;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .club-detail {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #94A3B8;
    }

    .club-lead {
      background: rgba(52, 168, 83, 0.1);
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
    }

    .club-lead-label {
      font-size: 0.75rem;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .club-lead-name {
      color: #34A853;
      font-weight: 600;
    }

    .club-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(66, 133, 244, 0.3);
    }

    .btn-secondary {
      background: rgba(30, 41, 59, 0.8);
      color: #E2E8F0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: rgba(30, 41, 59, 1);
    }

    .btn-danger {
      background: rgba(234, 67, 53, 0.2);
      color: #EA4335;
      border: 1px solid rgba(234, 67, 53, 0.3);
    }

    .btn-danger:hover {
      background: rgba(234, 67, 53, 0.3);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: hidden;
    }

    .modal-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: #E2E8F0;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      color: #E2E8F0;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: block;
      font-size: 0.95rem;
    }

    .form-label span {
      color: #EA4335;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #E2E8F0;
      font-family: 'Inter', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: rgba(66, 133, 244, 0.5);
      background: rgba(30, 41, 59, 0.7);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .logo-upload-container {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .logo-preview {
      width: 80px;
      height: 80px;
      border-radius: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(30, 41, 59, 0.5);
      overflow: hidden;
    }

    .logo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .logo-preview-empty {
      font-size: 2rem;
      color: #64748B;
    }

    .logo-upload-input {
      flex: 1;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.875rem 1rem;
      background: rgba(66, 133, 244, 0.1);
      border: 1px solid rgba(66, 133, 244, 0.3);
      border-radius: 0.75rem;
      color: #4285F4;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-input-label:hover {
      background: rgba(66, 133, 244, 0.2);
    }

    .club-logo {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
      .clubs-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="../../index.html" class="navbar-brand">
      üéì BVDU Event Management - Faculty
    </a>
    <div class="nav-menu">
      <a href="dashboard.html" class="nav-link">üéØ Events</a>
      <a href="od-forms.html" class="nav-link">üìã OD Forms</a>
      <a href="clubs.html" class="nav-link active">üé™ Clubs</a>
      <a href="create-event-leader.html" class="nav-link">üë• Create Event Leader</a>
      <a href="profile.html" class="nav-link">üë§ Profile</a>
      <a href="#" class="nav-link" id="logoutBtn">üö™ Logout</a>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Clubs Management</h1>
        <p class="page-subtitle">Manage clubs and assign club leads</p>
      </div>
      <button class="btn btn-primary" onclick="openCreateModal()">
        ‚ûï Create New Club
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üé™</span>
          <span class="stat-label">Total Clubs</span>
        </div>
        <div class="stat-value" id="totalClubs">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">‚úÖ</span>
          <span class="stat-label">Active Clubs</span>
        </div>
        <div class="stat-value" id="activeClubs">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üë•</span>
          <span class="stat-label">With Leads</span>
        </div>
        <div class="stat-value" id="clubsWithLeads">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <span class="stat-icon">üìä</span>
          <span class="stat-label">Categories</span>
        </div>
        <div class="stat-value" id="categoriesCount">0</div>
      </div>
    </div>

    <!-- Clubs Grid -->
    <div class="clubs-grid" id="clubsGrid">
      <!-- Clubs will be loaded here -->
    </div>
  </div>

  <!-- Create/Edit Club Modal -->
  <div class="modal" id="clubModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">Create New Club</h3>
      
      <form id="clubForm">
        <div class="form-group">
          <label class="form-label">Club Name <span>*</span></label>
          <input type="text" id="clubName" class="form-input" placeholder="Coding Club" required />
        </div>

        <div class="form-group">
          <label class="form-label">Category <span>*</span></label>
          <select id="clubCategory" class="form-select" required>
            <option value="">Select Category</option>
            <option value="Technical">Technical</option>
            <option value="Cultural">Cultural</option>
            <option value="Sports">Sports</option>
            <option value="Arts">Arts</option>
            <option value="Literary">Literary</option>
            <option value="Social">Social</option>
            <option value="Science">Science</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Club Logo</label>
          <div class="logo-upload-container">
            <div class="logo-preview" id="logoPreview">
              <span class="logo-preview-empty">üé™</span>
            </div>
            <div class="logo-upload-input">
              <div class="file-input-wrapper">
                <input type="file" id="clubLogo" accept="image/*" />
                <label for="clubLogo" class="file-input-label">
                  üì∏ Choose Logo
                </label>
              </div>
              <p style="font-size: 0.75rem; color: #64748B; margin-top: 0.5rem;">Recommended: 500x500px, PNG or JPG</p>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Description <span>*</span></label>
          <textarea id="clubDescription" class="form-textarea" placeholder="Brief description of the club..." required></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Club Lead (Event Leader)</label>
          <select id="clubLead" class="form-select">
            <option value="">No Lead Assigned</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Founded Year</label>
            <input type="number" id="foundedYear" class="form-input" placeholder="2024" min="1900" max="2100" />
          </div>

          <div class="form-group">
            <label class="form-label">Status <span>*</span></label>
            <select id="clubStatus" class="form-select" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">Create Club</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../js/config.js"></script>
  <script src="../../js/supabase-client.js"></script>
  <script>
    let allClubs = [];
    let eventLeaders = [];
    let editingClubId = null;
    let currentLogoFile = null;

    // Logo preview handler
    function initLogoPreview() {
      const logoInput = document.getElementById('clubLogo');
      const logoPreview = document.getElementById('logoPreview');
      
      logoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          currentLogoFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            logoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // Upload logo to Supabase Storage
    async function uploadLogo(file) {
      try {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Math.random().toString(36).substring(2)}-${Date.now()}.${fileExt}`;
        const filePath = `club-logos/${fileName}`;

        const { data, error } = await supabaseClient.storage
          .from('profile-photos')
          .upload(filePath, file);

        if (error) throw error;

        const { data: { publicUrl } } = supabaseClient.storage
          .from('profile-photos')
          .getPublicUrl(filePath);

        return publicUrl;
      } catch (error) {
        console.error('Error uploading logo:', error);
        throw error;
      }
    }

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? 'rgba(52, 168, 83, 0.95)' : 'rgba(234, 67, 53, 0.95)'};
        color: white;
        border-radius: 0.75rem;
        font-weight: 600;
        z-index: 10000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // Load Event Leaders
    async function loadEventLeaders() {
      try {
        console.log('Loading event leaders...');
        
        // First, test if we can query users table at all
        const { data: testData, error: testError } = await supabaseClient
          .from('users')
          .select('id, role')
          .limit(1);
        
        console.log('Test query result:', testData, 'Error:', testError);
        
        // First check all event leaders (including inactive)
        const { data: allEventLeaders, error: allError } = await supabaseClient
          .from('users')
          .select('id, full_name, email, role, is_active')
          .eq('role', 'event_leader')
          .order('full_name');
        
        console.log('All event leaders (including inactive):', allEventLeaders);
        
        // Now get only active event leaders
        const { data: leaders, error } = await supabaseClient
          .from('users')
          .select('id, full_name, email, role, is_active')
          .eq('role', 'event_leader')
          .eq('is_active', true)
          .order('full_name');

        if (error) {
          console.error('Supabase error loading event leaders:', error);
          console.error('Error details:', JSON.stringify(error, null, 2));
          throw error;
        }

        eventLeaders = leaders || [];
        console.log(`Loaded ${eventLeaders.length} ACTIVE event leaders:`, eventLeaders);
        console.log(`Total event leaders in DB: ${allEventLeaders?.length || 0}, Active: ${eventLeaders.length}`);
        
        // Populate dropdown
        const select = document.getElementById('clubLead');
        if (!select) {
          console.error('Club lead select element not found!');
          return;
        }
        
        select.innerHTML = '<option value="">No Lead Assigned</option>';
        
        if (eventLeaders.length === 0) {
          select.innerHTML += '<option value="" disabled>No Event Leaders Available</option>';
          console.warn('No event leaders found in database');
        } else {
          eventLeaders.forEach(leader => {
            select.innerHTML += `<option value="${leader.id}">${leader.full_name} (${leader.email})</option>`;
          });
        }

      } catch (error) {
        console.error('Error loading event leaders:', error);
        showNotification('Failed to load event leaders', 'error');
      }
    }

    // Load Clubs
    async function loadClubs() {
      try {
        const { data: clubs, error } = await supabaseClient
          .from('clubs')
          .select(`
            *,
            lead:club_lead_id(full_name, email)
          `)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allClubs = clubs || [];
        updateStats();
        renderClubs();

      } catch (error) {
        console.error('Error loading clubs:', error);
        showNotification('Failed to load clubs', 'error');
      }
    }

    // Update Stats
    function updateStats() {
      const total = allClubs.length;
      const active = allClubs.filter(c => c.is_active).length;
      const withLeads = allClubs.filter(c => c.club_lead_id).length;
      const categories = new Set(allClubs.map(c => c.category)).size;

      document.getElementById('totalClubs').textContent = total;
      document.getElementById('activeClubs').textContent = active;
      document.getElementById('clubsWithLeads').textContent = withLeads;
      document.getElementById('categoriesCount').textContent = categories;
    }

    // Render Clubs
    function renderClubs() {
      const grid = document.getElementById('clubsGrid');
      
      if (allClubs.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 4rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üé™</div>
            <h3 style="color: #E2E8F0; font-size: 1.5rem; margin-bottom: 0.5rem;">No Clubs Yet</h3>
            <p style="color: #94A3B8;">Create your first club to get started</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = allClubs.map(club => `
        <div class="club-card">
          <div class="club-header">
            <div class="club-icon">üé™</div>
            <div class="club-info">
              <div class="club-name">${club.name}</div>
              <span class="club-category">${club.category}</span>
            </div>
          </div>

          <div class="club-description">${club.description || 'No description'}</div>

          <div class="club-details">
            <div class="club-detail">
              <span>${club.is_active ? '‚úÖ' : '‚ùå'}</span>
              <span>${club.is_active ? 'Active' : 'Inactive'}</span>
            </div>
            ${club.founded_year ? `
              <div class="club-detail">
                <span>üìÖ</span>
                <span>Founded ${club.founded_year}</span>
              </div>
            ` : ''}
          </div>

          ${club.lead ? `
            <div class="club-lead">
              <div class="club-lead-label">Club Lead</div>
              <div class="club-lead-name">${club.lead.full_name}</div>
            </div>
          ` : `
            <div style="padding: 0.75rem; background: rgba(234, 67, 53, 0.1); border-radius: 0.5rem; color: #EA4335; font-size: 0.875rem; margin-bottom: 1rem;">
              ‚ö†Ô∏è No lead assigned
            </div>
          `}

          <div class="club-actions">
            <button class="btn btn-primary" onclick="editClub('${club.id}')">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn btn-danger" onclick="deleteClub('${club.id}', '${club.name}')">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Open Create Modal
    function openCreateModal() {
      editingClubId = null;
      currentLogoFile = null;
      document.getElementById('modalTitle').textContent = 'Create New Club';
      document.getElementById('submitBtn').textContent = 'Create Club';
      document.getElementById('clubForm').reset();
      document.getElementById('logoPreview').innerHTML = '<span class="logo-preview-empty">üé™</span>';
      document.getElementById('clubModal').classList.add('active');
    }

    // Edit Club
    function editClub(clubId) {
      const club = allClubs.find(c => c.id === clubId);
      if (!club) return;

      editingClubId = clubId;
      currentLogoFile = null;
      document.getElementById('modalTitle').textContent = 'Edit Club';
      document.getElementById('submitBtn').textContent = 'Update Club';
      
      document.getElementById('clubName').value = club.name;
      document.getElementById('clubCategory').value = club.category;
      document.getElementById('clubDescription').value = club.description || '';
      document.getElementById('clubLead').value = club.club_lead_id || '';
      document.getElementById('foundedYear').value = club.founded_year || '';
      document.getElementById('clubStatus').value = club.is_active ? 'active' : 'inactive';
      
      // Show existing logo
      const logoPreview = document.getElementById('logoPreview');
      if (club.logo_url) {
        logoPreview.innerHTML = `<img src="${club.logo_url}" alt="Current logo" />`;
      } else {
        logoPreview.innerHTML = '<span class="logo-preview-empty">üé™</span>';
      }

      document.getElementById('clubModal').classList.add('active');
    }

    // Delete Club
    async function deleteClub(clubId, clubName) {
      if (!confirm(`Are you sure you want to delete "${clubName}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('clubs')
          .delete()
          .eq('id', clubId);

        if (error) throw error;

        showNotification('Club deleted successfully', 'success');
        await loadClubs();

      } catch (error) {
        console.error('Error deleting club:', error);
        showNotification(error.message || 'Failed to delete club', 'error');
      }
    }

    // Close Modal
    function closeModal() {
      document.getElementById('clubModal').classList.remove('active');
      editingClubId = null;
      currentLogoFile = null;
      document.getElementById('logoPreview').innerHTML = '<span class="logo-preview-empty">üé™</span>';
    }

    // Form Submission
    document.getElementById('clubForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const name = document.getElementById('clubName').value.trim();
      const category = document.getElementById('clubCategory').value;
      const description = document.getElementById('clubDescription').value.trim();
      const leadId = document.getElementById('clubLead').value || null;
      const foundedYear = document.getElementById('foundedYear').value || null;
      const isActive = document.getElementById('clubStatus').value === 'active';

      submitBtn.disabled = true;
      submitBtn.textContent = editingClubId ? 'Updating...' : 'Creating...';

      try {
        // Upload logo if new file selected
        let logoUrl = null;
        if (currentLogoFile) {
          submitBtn.textContent = 'Uploading logo...';
          logoUrl = await uploadLogo(currentLogoFile);
        }

        const clubData = {
          name,
          category,
          description,
          club_lead_id: leadId,
          founded_year: foundedYear ? parseInt(foundedYear) : null,
          is_active: isActive
        };

        // Note: Logo is stored separately in storage bucket
        // Logo display will be handled by frontend using club ID

        if (editingClubId) {
          // Update
          const { error } = await supabaseClient
            .from('clubs')
            .update(clubData)
            .eq('id', editingClubId);

          if (error) throw error;
          showNotification('Club updated successfully', 'success');
        } else {
          // Create
          const { error } = await supabaseClient
            .from('clubs')
            .insert(clubData);

          if (error) throw error;
          showNotification('Club created successfully', 'success');
        }

        closeModal();
        await loadClubs();

      } catch (error) {
        console.error('Error saving club:', error);
        showNotification(error.message || 'Failed to save club', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = editingClubId ? 'Update Club' : 'Create Club';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async function(e) {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        await supabaseClient.auth.signOut();
        sessionStorage.clear();
        localStorage.removeItem('currentUser');
        window.location.href = '../../login.html';
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Initializing clubs page...');
      initLogoPreview();
      await loadEventLeaders();
      await loadClubs();
      console.log('Clubs page initialized');
    });
  </script>
</body>
</html>
